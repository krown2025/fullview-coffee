<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center my-4">
        <h1>Promotions</h1>
        <a href="/branch/dashboard" class="btn btn-secondary">Back to Dashboard</a>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">Create Promotion</div>
                <div class="card-body">
                    <form action="/branch/promotions/create" method="POST">
                        <div class="mb-3">
                            <label class="form-label">Target</label>
                            <select name="target_type" class="form-select" id="targetTypeSelect"
                                onchange="toggleTargetFields()">
                                <option value="order">Entire Order</option>
                                <option value="category">Specific Category</option>
                                <option value="product">Specific Product</option>
                            </select>
                        </div>

                        <div class="mb-3 d-none" id="categorySelectDiv">
                            <label class="form-label">Category</label>
                            <select name="target_id" class="form-select" id="categorySelect" disabled>
                                <option value="">Select Category</option>
                                <% categories.forEach(cat=> { %>
                                    <option value="<%= cat.id %>">
                                        <%= cat.name %>
                                    </option>
                                    <% }) %>
                            </select>
                        </div>

                        <div class="mb-3 d-none" id="productSelectDiv">
                            <label class="form-label">Product</label>
                            <select name="target_id" class="form-select" id="productSelect" disabled>
                                <option value="">Select Product</option>
                                <% products.forEach(prod=> { %>
                                    <option value="<%= prod.id %>">
                                        <%= prod.name %>
                                    </option>
                                    <% }) %>
                            </select>
                        </div>

                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" name="is_auto_applied" id="autoApplyCheck">
                            <label class="form-check-label" for="autoApplyCheck">Auto Apply (No Code Required)</label>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Code</label>
                            <input type="text" name="code" class="form-control" id="promoCodeInput" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Type</label>
                            <select name="type" class="form-select">
                                <option value="percentage">Percentage (%)</option>
                                <option value="fixed">Fixed Amount (SAR)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Value</label>
                            <input type="number" step="0.01" name="value" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" name="start_date" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">End Date</label>
                            <input type="date" name="end_date" class="form-control">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Create</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card">
                <div class="card-header">Active Promotions</div>
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Target</th>
                                <th>Type</th>
                                <th>Value</th>
                                <th>Dates</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% promotions.forEach(p=> { %>
                                <tr>
                                    <td>
                                        <%= p.code %>
                                            <% if(p.is_auto_applied) { %> <span class="badge bg-success">Auto</span>
                                                <% } %>
                                    </td>
                                    <td>
                                        <% if(p.target_type==='order' ) { %>
                                            <span class="badge bg-primary">Order</span>
                                            <% } else if(p.target_type==='category' ) { %>
                                                <span class="badge bg-info">Category: <%= p.category_name %></span>
                                                <% } else if(p.target_type==='product' ) { %>
                                                    <span class="badge bg-warning text-dark">Product: <%= p.product_name
                                                            %></span>
                                                    <% } %>
                                    </td>
                                    <td>
                                        <%= p.type %>
                                    </td>
                                    <td>
                                        <%= p.value %>
                                    </td>
                                    <td>
                                        <%= p.start_date ? new Date(p.start_date).toLocaleDateString() : 'N/A' %> - <%=
                                                p.end_date ? new Date(p.end_date).toLocaleDateString() : 'N/A' %>
                                    </td>
                                    <td>
                                        <form action="/branch/promotions/delete/<%= p.id %>" method="POST"
                                            onsubmit="return confirm('Are you sure?')">
                                            <button class="btn btn-sm btn-danger">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                                <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleTargetFields() {
        const type = document.getElementById('targetTypeSelect').value;
        const catDiv = document.getElementById('categorySelectDiv');
        const prodDiv = document.getElementById('productSelectDiv');
        const catSelect = document.getElementById('categorySelect');
        const prodSelect = document.getElementById('productSelect');
        const codeInput = document.getElementById('promoCodeInput');
        const autoApplyCheck = document.getElementById('autoApplyCheck');

        catDiv.classList.add('d-none');
        prodDiv.classList.add('d-none');
        catSelect.disabled = true;
        prodSelect.disabled = true;
        catSelect.name = ""; // Remove name so it doesn't submit
        prodSelect.name = "";

        if (type === 'category') {
            catDiv.classList.remove('d-none');
            catSelect.disabled = false;
            catSelect.name = "target_id";
        } else if (type === 'product') {
            prodDiv.classList.remove('d-none');
            prodSelect.disabled = false;
            prodSelect.name = "target_id";
        }

        // Toggle Code Required
        if (autoApplyCheck.checked) {
            codeInput.removeAttribute('required');
            codeInput.placeholder = "Optional (Auto-generated if empty)";
        } else {
            codeInput.setAttribute('required', 'required');
            codeInput.placeholder = "";
        }
    }

    document.getElementById('autoApplyCheck').addEventListener('change', toggleTargetFields);
    // Run on load
    toggleTargetFields();
</script>