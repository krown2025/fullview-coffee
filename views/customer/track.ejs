<div class="container text-center mt-5">
    <h1 class="mb-4">Order Tracking</h1>
    <div class="card shadow-sm">
        <div class="card-body">
            <h3 class="card-title">Order #<%= order.id %>
            </h3>
            <p class="text-muted">Thank you, <%= order.customer_name %>
            </p>

            <% if(order.order_type==='car_pickup' ) { %>
                <div class="mb-4">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=Order-<%= order.id %>"
                        alt="Order QR Code" class="img-thumbnail">
                    <p class="small text-muted mt-1">Show this QR code to the runner</p>
                </div>
                <% } %>

                    <div class="my-5">
                        <div class="progress" style="height: 30px;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                                role="progressbar" style="width: 10%;" aria-valuenow="10" aria-valuemin="0"
                                aria-valuemax="100">
                                Pending
                            </div>
                        </div>
                    </div>

                    <div id="status-display" class="display-4 mb-3 text-warning">
                        <%= order.status.toUpperCase() %>
                    </div>

                    <div id="timer-container" style="display: none;">
                        <p>Estimated time remaining:</p>
                        <h2 id="countdown" class="text-danger">00:00</h2>
                    </div>

                    <div id="ready-message" style="display: none;">
                        <div class="alert alert-success">
                            <h4>Your order is ready!</h4>
                            <p>Please proceed to the counter/pickup area.</p>
                        </div>
                    </div>
        </div>
    </div>
    <a href="/" class="btn btn-outline-secondary mt-4">Back to Menu</a>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const orderId = <%= order.id %>;
    let currentStatus = '<%= order.status %>';
    let prepTimeMinutes = <%= order.prep_time_minutes || 0 %>;
    let updatedAt = new Date('<%= order.updated_at || order.created_at %>');

    function updateUI(status, prepTime) {
        const progressBar = document.getElementById('progress-bar');
        const statusDisplay = document.getElementById('status-display');
        const timerContainer = document.getElementById('timer-container');
        const readyMessage = document.getElementById('ready-message');

        statusDisplay.innerText = status.toUpperCase();

        if (status === 'new') {
            progressBar.style.width = '10%';
            progressBar.className = 'progress-bar progress-bar-striped bg-secondary';
            progressBar.innerText = 'Pending';
        } else if (status === 'preparing') {
            progressBar.style.width = '50%';
            progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-warning';
            progressBar.innerText = 'Preparing';

            if (prepTime) {
                startTimer(prepTime);
                timerContainer.style.display = 'block';
            }
        } else if (status === 'ready') {
            progressBar.style.width = '100%';
            progressBar.className = 'progress-bar bg-success';
            progressBar.innerText = 'Ready';
            timerContainer.style.display = 'none';
            readyMessage.style.display = 'block';

            // Play sound
            const audio = new Audio('/sounds/notification.mp3');
            audio.play().catch(e => console.log('Audio play failed', e));
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        } else if (status === 'completed') {
            progressBar.style.width = '100%';
            progressBar.className = 'progress-bar bg-primary';
            progressBar.innerText = 'Completed';
            readyMessage.style.display = 'none';
        }
    }

    function startTimer(minutes) {
        let seconds = minutes * 60;
        const display = document.getElementById('countdown');

        const interval = setInterval(() => {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            display.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;

            if (--seconds < 0) {
                clearInterval(interval);
                display.innerText = "Soon...";
            }
        }, 1000);
    }

    // Initial State
    updateUI(currentStatus, prepTimeMinutes);

    // Socket Listener
    socket.on(`order_${orderId}`, (data) => {
        console.log('Order Update:', data);
        updateUI(data.status, data.prep_time);
    });
</script>